- name: Install Erlang and RabbitMQ on Debian
  hosts: debian_servers
  become: yes

  tasks:
    - name: Install dependencies
      apt:
        name:
          - software-properties-common
          - curl
          - gnupg2
          - apt-transport-https
        state: present
        update_cache: yes

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Add RabbitMQ repository signing key
      apt_key:
        url: https://packages.rabbitmq.com/rabbitmq-release-signing-key.asc
        state: present

    - name: Add RabbitMQ repository
      apt_repository:
        repo: "deb https://dl.bintray.com/rabbitmq-erlang/debian bionic erlang"
        state: present

    - name: Add official RabbitMQ repository
      apt_repository:
        repo: "deb https://dl.bintray.com/rabbitmq/debian bionic main"
        state: present

    - name: Install Erlang
      apt:
        name: erlang
        state: present

    - name: Check Erlang version
      command: "erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().' -noshell"
      register: erl_version

    - name: Display Erlang version
      debug:
        msg: "Erlang version: {{ erl_version.stdout }}"

    - name: Install RabbitMQ server
      apt:
        name: rabbitmq-server
        state: present

    - name: Start RabbitMQ server
      systemd:
        name: rabbitmq-server
        state: started
        enabled: yes

    - name: Check RabbitMQ server status
      command: systemctl status rabbitmq-server
      register: rabbitmq_status

    - name: Display RabbitMQ server status
      debug:
        msg: "RabbitMQ status: {{ rabbitmq_status.stdout }}"

    - name: Get RabbitMQ version
      command: rabbitmqctl version
      register: rabbitmq_version_output
      changed_when: False

    - name: Display RabbitMQ version
      debug:
        msg: "RabbitMQ version: {{ rabbitmq_version_output.stdout }}"
